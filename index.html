<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WorkSpace Café — اطلب الآن</title>
  <style>
    :root{
      --bg:#120a07;
      --panel:#241810;
      --muted:#c7b39b;
      --accent:#d4ac6e;
      --card:#2f2220;
      --card-contrast:#efebe9;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:linear-gradient(180deg,#120a07 0%, #19100d 100%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
    }
    header{
      position:sticky;top:0;z-index:40;padding:14px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.25));
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:10px;overflow:hidden;flex-shrink:0}
    .logo img{width:100%;height:100%;object-fit:cover}
    .title{font-size:18px;color:var(--accent);font-weight:800}
    .subtitle{color:var(--muted);font-size:13px}
    .search input{width:320px;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
      background:rgba(255,255,255,0.02);color:#fff;font-size:14px}
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px 140px}
    .section-title{margin:22px 0 8px;color:var(--accent);font-size:20px;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;
      border:1px solid rgba(255,255,255,0.03);min-height:230px;
    }
    .card .imgwrap{height:130px;border-radius:10px;overflow:hidden;background:#111;display:flex;align-items:center;justify-content:center}
    .card img{width:100%;height:100%;object-fit:contain;display:block}
    .card .name{font-weight:700;margin-top:6px}
    .card .price{color:var(--muted);font-weight:700}
    .qty-row{margin-top:auto;display:flex;align-items:center;justify-content:center;gap:12px}
    .qty-btn{width:36px;height:36px;border-radius:8px;border:none;background:var(--accent);color:#111;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
    .qty-display{min-width:44px;text-align:center;font-weight:700;font-size:16px;color:var(--card-contrast);background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px}
    .bottom-bar{position:fixed;left:0;right:0;bottom:0;z-index:50;background:linear-gradient(90deg, rgba(18,10,7,0.95), rgba(28,18,14,0.95));border-top:1px solid rgba(255,255,255,0.04);padding:12px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .summary{display:flex;gap:18px;align-items:center;color:var(--card-contrast)}
    .summary .total{font-weight:800;font-size:18px}
    .confirm-btn{background:var(--accent);color:#111;border:none;padding:10px 16px;border-radius:10px;font-weight:800;cursor:pointer}
    #orderSummaryBox{max-width:960px;margin:18px auto;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);color:var(--card-contrast);display:none}
    #orderSummaryList div{padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
    #orderSummaryList div:last-child{border-bottom:none}
    .cart-count{background:#fff;color:#111;padding:4px 8px;border-radius:999px;font-weight:800}
    .spacer{height:88px}
    .btn-disabled{opacity:0.6;cursor:not-allowed}
    .loader{display:inline-block;border:3px solid rgba(0,0,0,0);border-left-color:rgba(0,0,0,0.1);width:18px;height:18px;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-left:8px;background:linear-gradient(90deg,#fff,#ddd);opacity:0.9}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* small responsive tweaks */
    @media (max-width:480px){
      .search input{width:100%}
      .logo{width:48px;height:48px}
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo"><img src="https://images.unsplash.com/photo-1511920170033-f8396924c348?q=80&w=800&auto=format&fit=crop" alt="logo"></div>
    <div>
      <div class="title">WorkSpace Café</div>
      <div class="subtitle">الدفع عند الاستلام · اطلب الآن</div>
    </div>
  </div>
  <div class="search" style="flex:1;margin-left:18px">
    <input id="searchInput" type="search" placeholder="ابحث عن مشروب أو سناك..." aria-label="بحث">
  </div>
</header>

<div class="wrap">
  <div>
    <div class="section-title">المشروبات</div>
    <div id="drinksGrid" class="grid"></div>
  </div>

  <div style="margin-top:18px">
    <div class="section-title">السناكس</div>
    <div id="snacksGrid" class="grid"></div>
  </div>

  <div id="orderSummaryBox">
    <h3>تفاصيل الطلب</h3>
    <div id="orderSummaryList"></div>
  </div>
</div>

<div class="spacer"></div>

<!-- bottom fixed summary -->
<div class="bottom-bar">
  <div class="summary">
    <div>العناصر: <span id="itemsCount" class="cart-count">0</span></div>
    <div class="total">الإجمالي: <span id="totalAmount">0</span> ج.م</div>
  </div>
  <div style="display:flex;gap:12px;align-items:center">
    <button id="confirmOrder" class="confirm-btn">تأكيد الطلب</button>
  </div>
</div>

<script>
/* ============ رابط Web App (محدث) ============ */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbySdCfmtIGtCjT3ZdMJ4TMhaY3-D7qDN1IV5I3it153oK7gYIv7FYc6X7K8tTS4stuAPQ/exec";

/* ============ منتجات: عدّل إن أردت ============ */
const drinks = [
  {name:"كوفي بريك 2/1", price:25, img:"https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1200&auto=format&fit=crop"},
  {name:"كوفي بريك3/1", price:25, img:"https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1200&auto=format&fit=crop"},
  {name:"كابتشينو موكا بونجورنو", price:30, img:"https://kitchen.sayidaty.net/uploads/small/bd/bd6fe84636e832188966978d0b33df89_w240_h240.jpg"},
  {name:"كابتشينو بندق", price:30, img:"https://png.pngtree.com/background/20230606/original/pngtree-cappuccino-with-hazelnuts-on-wooden-background-cappuccino-with-chocolate-powder-on-picture-image_2877924.jpg"},
  {name:"مشروب كاكاو", price:20, img:"https://kitchen.sayidaty.net/uploads/small/07/074968944610cfa33478d4624f3acf6c_w750_h750.jpg"},
  {name:"قهوه بسيطة", price:25, img:"https://i1.sndcdn.com/artworks-000219824277-bq4b2z-t500x500.jpg"},
  {name:"شاي", price:10, img:"https://ichef.bbci.co.uk/ace/ws/640/cpsprodpb/2AAE/production/_108962901_hi053405374.jpg.webp"}
];

const snacks = [
  {name:"اندومي صغير", price:5, img:"https://m.media-amazon.com/images/I/41f-8OER9bL._AC_.jpg"},
  {name:"توينكز دبل ك", price:10, img:"https://m.media-amazon.com/images/I/6144UtFOGvL._AC_SX679_.jpg"},
  {name:"بيك رولز جبنه", price:10, img:"https://m.media-amazon.com/images/I/71L42GIxo6L._UF894,1000_QL80_.jpg"}
];

/* ============ حالة السلة وDOM references ============ */
let state = {}; // { "اسم المنتج": {qty, price, type} }
const drinksGrid = document.getElementById('drinksGrid');
const snacksGrid = document.getElementById('snacksGrid');
const itemsCountEl = document.getElementById('itemsCount');
const totalAmountEl = document.getElementById('totalAmount');
const confirmOrderBtn = document.getElementById('confirmOrder');
const searchInput = document.getElementById('searchInput');
const orderSummaryBox = document.getElementById('orderSummaryBox');
const orderSummaryList = document.getElementById('orderSummaryList');

/* ============ وظائف مساعدة ============ */
function createCardHTML(item, type){
  const id = encodeURIComponent(item.name).replace(/%/g,'');
  return `
    <div class="card" data-name="${item.name}" data-type="${type}">
      <div class="imgwrap"><img src="${item.img}" alt="${item.name}" loading="lazy" onerror="this.src='https://images.unsplash.com/photo-1492724441997-5dc865305da7?q=80&w=1200&auto=format&fit=crop'"></div>
      <div class="name">${item.name}</div>
      <div class="price">${item.price} ج.م</div>
      <div class="qty-row">
        <button class="qty-btn" data-action="dec" data-name="${item.name}">−</button>
        <div class="qty-display" id="qty_${id}">0</div>
        <button class="qty-btn" data-action="inc" data-name="${item.name}">+</button>
      </div>
    </div>
  `;
}

function renderAll(){
  drinksGrid.innerHTML = drinks.map(d => createCardHTML(d,'مشروب')).join('');
  snacksGrid.innerHTML = snacks.map(s => createCardHTML(s,'سناك')).join('');
  document.querySelectorAll('.qty-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const action = btn.dataset.action;
      const name = btn.dataset.name;
      changeQuantity(name, action === 'inc' ? 1 : -1);
    });
  });
}

function findPrice(name){
  const f1 = drinks.find(d=>d.name===name);
  if(f1) return f1.price;
  const f2 = snacks.find(s=>s.name===name);
  if(f2) return f2.price;
  return 0;
}
function findType(name){
  const f1 = drinks.find(d=>d.name===name);
  if(f1) return 'مشروب';
  const f2 = snacks.find(s=>s.name===name);
  if(f2) return 'سناك';
  return '';
}

function changeQuantity(name, delta){
  if(!state[name]) state[name] = { qty:0, price: findPrice(name), type: findType(name) };
  state[name].qty = Math.max(0, state[name].qty + delta);
  const id = encodeURIComponent(name).replace(/%/g,'');
  const el = document.getElementById('qty_'+id);
  if(el) el.textContent = state[name].qty;
  updateSummary();
}

function updateSummary(){
  let total = 0, itemsCount = 0;
  for(const [name, obj] of Object.entries(state)){
    if(obj.qty <= 0) continue;
    itemsCount += obj.qty;
    total += obj.qty * obj.price;
  }
  itemsCountEl.textContent = itemsCount;
  totalAmountEl.textContent = total;
}

function buildOrderSummaryText(){
  const lines = [];
  let total = 0;
  for(const [name, obj] of Object.entries(state)){
    if(obj.qty <= 0) continue;
    const lineTotal = obj.qty * obj.price;
    total += lineTotal;
    lines.push(`${name} x${obj.qty} — ${lineTotal} ج.م (السعر: ${obj.price} ج.م, النوع: ${obj.type})`);
  }
  return { lines, total };
}

/* ============ حدث التأكيد (إرسال إلى Web App باستخدام FormData لتجنب preflight) ============ */
confirmOrderBtn.addEventListener('click', async ()=>{
  const summary = buildOrderSummaryText();
  if(summary.lines.length === 0){ alert('السلة فارغة — اضف منتجات أولاً'); return; }

  const customerName = prompt('ادخل اسم العميل (اختياري):') || 'عميل مجهول';

  // عرض ملخص الطلب
  orderSummaryList.innerHTML = summary.lines.map(l=>`<div>${l}</div>`).join('') +
                               `<div style="margin-top:10px;font-weight:bold;color:var(--accent)">الإجمالي: ${summary.total} ج.م</div>`;
  orderSummaryBox.style.display = 'block';
  orderSummaryBox.scrollIntoView({behavior:'smooth', block:'center'});

  const payload = {
    name: customerName.trim(),
    details: summary.lines.join(' | '),
    type: 'متعدد',
    price: summary.total,
    total: summary.total
  };

  // بناء FormData (لا نحدد Content-Type حتى لا يحصل preflight)
  const form = new FormData();
  form.append('name', payload.name);
  form.append('details', payload.details);
  form.append('type', payload.type);
  form.append('price', String(payload.price));
  form.append('total', String(payload.total));

  // تعطيل الزر واضافة مؤشر تحميل
  confirmOrderBtn.disabled = true;
  confirmOrderBtn.classList.add('btn-disabled');
  const loader = document.createElement('span');
  loader.className = 'loader';
  loader.id = 'sendingLoader';
  confirmOrderBtn.appendChild(loader);

  try{
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      body: form
    });

    if(!res.ok){
      const text = await res.text().catch(()=> '');
      console.error('Server responded with status', res.status, text);
      alert('حدث خطأ أثناء الإرسال. رمز الحالة: ' + res.status + '\nتحقق من Console للمزيد.');
      return;
    }

    const result = await res.json().catch(()=> null);
    if(result && result.status === 'success'){
      alert('✅ تم إرسال الطلب بنجاح! رقم الطلب: ' + (result.orderId || '—'));
      // إعادة تعيين الواجهة
      state = {};
      document.querySelectorAll('[id^="qty_"]').forEach(el=>el.textContent = '0');
      updateSummary();
      orderSummaryBox.style.display = 'none';
    } else {
      console.error('Server returned error', result);
      alert('حدث خطأ من الخادم: ' + (result && result.message ? result.message : 'غير معروف'));
    }
  } catch(err){
    console.error('Fetch error', err);
    alert('فشل الاتصال بالخادم. تحقق من الإنترنت وإعداد Web App.\nانظر Console للمزيد من التفاصيل.');
  } finally {
    // إعادة تمكين الزر وإزالة مؤشر التحميل
    confirmOrderBtn.disabled = false;
    confirmOrderBtn.classList.remove('btn-disabled');
    const existing = document.getElementById('sendingLoader');
    if(existing) existing.remove();
  }
});

/* ============ وظيفة البحث ============ */
searchInput.addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  document.querySelectorAll('.card').forEach(card=>{
    const name = (card.dataset.name || '').toLowerCase();
    card.style.display = name.includes(q) ? '' : 'none';
  });
});

/* ============ init ============ */
renderAll();
updateSummary();
</script>
</body>
</html>


